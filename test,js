/***********************
 * Slides for each section
 ***********************/
const ALL_SECTIONS = {
  'structure': [
    { title: "Section 1: The Three Branches of Government", content: "Ohio’s government has three branches that work together to keep power balanced. The legislative branch (the General Assembly) makes the laws. The executive branch (led by the Governor) carries out the laws. The judicial branch (the court system) interprets the laws and makes sure they are applied fairly." },
    { title: "Section 2: Ohio’s Constitution", content: "The Ohio Constitution is the foundation of the state’s government. It explains how Ohio is organized and how its three branches — legislative, executive, and judicial — share power. The Constitution lists the rights and freedoms of Ohio’s citizens, describes how state laws are created, and sets rules for how government officials are chosen and what they can do. It helps make sure the government is fair, balanced, and serves the people of Ohio." },
    { title: "Section 3: Ohio vs. U.S. Government", content: "The Ohio government and the U.S. government are similar because both have three branches — legislative, executive, and judicial — and both make and enforce laws. However, the Ohio government focuses only on state issues, like schools, roads, and local taxes, while the U.S. government handles national issues, such as defense and foreign policy. This means Ohio’s laws apply just within the state, while federal laws apply to the whole country." },
  ],
  'legislative': [
    { title: "Section 1: Two Houses of the General Assembly", content: "The Ohio General Assembly has two houses that work together to make state laws. The House of Representatives has 99 members who represent smaller districts, and the Senate has 33 members who represent larger districts. Both houses must agree on a bill before it can become a law in Ohio." },
    { title: "Section 2: Terms and Qualifications", content: "Members of the Ohio House of Representatives serve two-year terms, and members of the Ohio Senate serve four-year terms. To qualify, a person must be at least 18 years old, live in their district for at least one year before the election, and be a registered voter in Ohio." },
    { title: "Section 3: Making and Passing Laws", content: "In Ohio, a bill starts as an idea that is written and introduced in the General Assembly. Both the House and Senate must discuss and approve it. After that, the Governor reviews the bill and can sign it into law or veto it. If vetoed, the General Assembly can override the veto with a three-fifths vote." },
  ],
  'executive': [
    { title: "Section 1: The Governor of Ohio", content: "The Governor of Ohio is the state’s chief executive and leader of the government. The Governor’s job is to enforce state laws, prepare the budget, and work with the General Assembly to make sure Ohio runs smoothly." },
    { title: "Section 2: State Budget and Finances", content: "The state budget is a plan for how Ohio’s money will be collected and spent. The Governor prepares the budget and sends it to the General Assembly for approval. The Auditor of State checks that all public money is used properly and spent for the right purposes." },
    { title: "Section 3: The Attorney General’s Role", content: "The Ohio Attorney General is the state’s top lawyer. Their job is to protect the legal rights of Ohio and its citizens. They represent the state in court, give legal advice to state agencies, and help make sure laws are followed fairly across Ohio." }
  ],
  'judicial': [
    { title: "Section 1: Role of the Judicial Branch", content: "The judicial branch is the part of Ohio’s government that interprets the laws and makes sure they are applied fairly. It settles disagreements, protects people’s rights, and ensures that laws follow the Ohio and U.S. Constitutions." },
    { title: "Section 2: The Ohio Supreme Court", content: "The Ohio Supreme Court is the highest court in the state. It reviews important cases and decides if laws or government actions follow the Ohio and U.S. Constitutions. The court’s decisions guide all other courts in Ohio." },
    { title: "Section 3: Other State Courts", content: "Below the Ohio Supreme Court are appeals courts and local courts, which handle cases involving individuals, businesses, and communities. These courts make most of the day-to-day legal decisions in Ohio and ensure that justice is carried out fairly across the state." },
  ],
  'leadershiproles': [
    { title: "Section 1: President of the Ohio Senate", content: "The President of the Ohio Senate is the leader of the Senate. They guide discussions, decide which bills are debated, and help manage the work of the senators. The President also works with other state leaders to move important laws forward." },
    { title: "Section 2: Speaker of the House", content: "The Speaker of the House is the leader of the Ohio House of Representatives. They run meetings, decide which bills are discussed, and help organize the work of the representatives. The Speaker plays an important role in guiding laws through the House." },
    { title: "Section 3: Cooperation Between Leaders", content: "In Ohio’s government, leaders like the Governor, Senate President, and Speaker of the House work together to create and pass laws. Their cooperation helps keep the government running smoothly and ensures that decisions reflect the needs of the people of Ohio." },
  ],
  'citizenshipandvoting': [
    { title: "Section 1: Voting Requirements in Ohio", content: "To vote in Ohio, you must be a U.S. citizen, at least 18 years old by the next general election, and a resident of Ohio for at least 30 days before the election. You must also not be in prison for a felony, not declared incompetent to vote by a court, and not permanently banned from voting for breaking election laws." },
    { title: "Section 2: Ohio’s Counties", content: "Ohio is divided into 88 counties, each with its own local government that helps carry out state laws and provide services like roads, law enforcement, and public records. Counties make it easier to manage and serve the people who live in different parts of the state." },
    { title: "Section 3: Citizen Participation", content: "Citizen participation means getting involved in government by voting, sharing opinions, and staying informed about issues. When citizens take part, they help shape the decisions that affect their communities and the state." },
  ]
};

/***********************
 * Presentation & Minigames - Full Reliable Implementation
 ***********************/
(function () {
  /* ---------- DOM refs ---------- */
  const sectionsGrid = document.getElementById('sectionsGrid');
  const menuWrap = document.getElementById('menuWrap');
  const presentationContainer = document.getElementById('presentationContainer');
  const backButton = document.getElementById('backButton');
  const progressWrapper = document.querySelector('.progress-wrapper');
  const progressStepsEl = document.getElementById('progressSteps');
  const studyContent = document.getElementById('studyContent');
  const titleEl = document.getElementById('sectionTitle');
  const contentEl = document.getElementById('sectionContent');
  const nextBtn = document.getElementById('nextBtn');

  /* ---------- state ---------- */
  let progressFillEl = null;
  let circles = [];
  let slides = [];
  let current = 0;
  let onNextClick = null;
  let onKeyDown = null;
  let onResize = null;
  let activeKey = null;

  /* ---------- safe cleanup ---------- */
  function cleanupPresentation() {
    const presInner = document.querySelector('.presentation-inner');
    const progressWrapper = document.querySelector('.progress-wrapper');

    if (presInner) {
      presInner.style.display = 'none';
      presInner.style.height = '0';
      presInner.style.overflow = 'hidden';
    }
    if (progressWrapper) {
      progressWrapper.style.display = 'none';
    }

    presentationContainer.style.display = 'flex';
    presentationContainer.style.flexDirection = 'column';
    presentationContainer.style.height = 'auto';
    presentationContainer.style.minHeight = '0';
    presentationContainer.style.padding = '0';
    presentationContainer.style.margin = '0';
  }

  /* ---------- complete topic ---------- */
  function completeTopic(key) {
    cleanupPresentation();
    presentationContainer.classList.remove('presentation-active');
    if (menuWrap) menuWrap.style.display = '';

    const card = document.querySelector(`.section-card[data-key="${key}"]`);
    if (card) {
      card.classList.add('completed-topic');
      card.textContent = '✅ Completed';
      card.style.backgroundColor = '#34a853';
      card.style.color = '#fff';
      card.style.pointerEvents = 'none';
    }

    // 🔹 FIX: restore layout for next presentation
    presentationContainer.style.height = '';
    presentationContainer.style.minHeight = '';
    presentationContainer.style.padding = '';
    presentationContainer.style.margin = '';
  }

  /* ---------- helper functions ---------- */
  function markCompleted(index) {
    const el = circles[index];
    if (!el) return;
    el.classList.add('completed');
    const num = el.querySelector('.num');
    if (num) num.textContent = '✔';
  }
  function setActive(index) {
    circles.forEach((el, idx) => el.classList.toggle('active', idx === index));
  }
  function updateLineProgress() {
    if (!progressFillEl || circles.length === 0) return;
    const wrapperRect = progressWrapper.getBoundingClientRect();
    const centers = circles.map(c => {
      const r = c.getBoundingClientRect();
      return (r.left + r.right) / 2 - wrapperRect.left;
    });
    const firstCenter = centers[0];
    const currentCenter = centers[Math.min(current, centers.length - 1)];
    progressFillEl.style.left = Math.round(firstCenter) + 'px';
    progressFillEl.style.width = Math.max(0, Math.round(currentCenter - firstCenter)) + 'px';
  }

  function goToSlide(skipFade = false) {
    const s = slides[current];
    if (!s) return;
    titleEl.textContent = s.title;
    contentEl.textContent = s.content;
    setActive(current);
    circles.forEach((el, idx) => {
      if (idx < current) markCompleted(idx);
      else el.classList.remove('completed');
    });
    updateLineProgress();
    if (nextBtn) {
      nextBtn.disabled = false;
      nextBtn.textContent = (current === slides.length - 1) ? 'Finish' : 'Continue →';
    }
  }

  function initPresentationFor(slideSet, key) {
    cleanupPresentation();
    slides = slideSet || [];
    current = 0;
    activeKey = key;

    if (menuWrap) menuWrap.style.display = 'none';
    presentationContainer.classList.add('presentation-active');
    if (progressWrapper) progressWrapper.style.display = '';
    if (studyContent) studyContent.style.display = '';

    progressFillEl = document.createElement('div');
    progressFillEl.className = 'progress-fill';
    progressWrapper.appendChild(progressFillEl);

    progressStepsEl.innerHTML = '';
    circles = [];
    slides.forEach((_, i) => {
      const c = document.createElement('button');
      c.type = 'button';
      c.className = 'circle';
      c.setAttribute('data-index', i);
      const span = document.createElement('span');
      span.className = 'num';
      span.textContent = (i + 1);
      c.appendChild(span);
      progressStepsEl.appendChild(c);
      circles.push(c);
      c.addEventListener('click', (ev) => {
        const idx = Number(ev.currentTarget.getAttribute('data-index'));
        if (isNaN(idx)) return;
        current = idx;
        goToSlide(true);
      });
    });

    onResize = () => updateLineProgress();
    window.addEventListener('resize', onResize);

    onNextClick = function () {
      if (current < slides.length - 1) {
        markCompleted(current);
        current++;
        goToSlide();
      } else {
        markCompleted(current);
        nextBtn.disabled = true;
        nextBtn.textContent = '✅ Finished';
        if (progressWrapper) progressWrapper.style.display = 'none';
        if (studyContent) studyContent.style.display = 'none';

        if (key === 'structure') {
          launchMatchGame(key);
        } else if (key === 'legislative') {
          launchLawmakerGame(key);
        } else {
          completeTopic(key);
        }
      }
    };
    nextBtn.addEventListener('click', onNextClick);

    onKeyDown = (e) => {
      if (e.key === 'ArrowRight') {
        if (current < slides.length - 1) { markCompleted(current); current++; goToSlide(); }
      } else if (e.key === 'ArrowLeft') {
        if (current > 0) { current--; goToSlide(); }
      }
    };
    window.addEventListener('keydown', onKeyDown);
    goToSlide(true);
    requestAnimationFrame(updateLineProgress);
  }

  sectionsGrid.addEventListener('click', ev => {
    const card = ev.target.closest('.section-card');
    if (!card || card.classList.contains('completed-topic')) return;
    const key = card.dataset.key;
    const slideSet = ALL_SECTIONS[key];
    if (!slideSet) { alert('Slides unavailable.'); return; }
    initPresentationFor(slideSet, key);
  });

  backButton.addEventListener('click', () => {
    cleanupPresentation();
    presentationContainer.classList.remove('presentation-active');
    if (menuWrap) menuWrap.style.display = '';
  });

  /* ---------- Helper for overlays ---------- */
  function createOverlayWrapper() {
    document.querySelectorAll('.overlay-game').forEach(e => e.remove());
    const wrap = document.createElement('div');
    wrap.className = 'overlay-game';
    wrap.style.width = '100%';
    wrap.style.maxWidth = '980px';
    wrap.style.margin = '0 auto'; // 🔹 FIX
    wrap.style.padding = '20px';
    wrap.style.boxSizing = 'border-box';
    wrap.style.background = '#fff';
    wrap.style.borderRadius = '12px';
    wrap.style.boxShadow = '0 8px 24px rgba(0,0,0,0.06)';
    wrap.style.flex = '1'; // 🔹 FIX
    return wrap;
  }

  /* ---------- Match Game ---------- */
  function launchMatchGame(key) {
    const overlay = createOverlayWrapper();

    // 🔹 FIX: remove white space from study area
    if (studyContent) {
      studyContent.style.display = 'none';
      studyContent.style.height = '0';
      studyContent.style.overflow = 'hidden';
      studyContent.style.margin = '0';
      studyContent.style.padding = '0';
    }
    if (progressWrapper) {
      progressWrapper.style.display = 'none';
      progressWrapper.style.height = '0';
      progressWrapper.style.overflow = 'hidden';
      progressWrapper.style.margin = '0';
      progressWrapper.style.padding = '0';
    }
    if (presentationContainer) {
      presentationContainer.style.display = 'flex';
      presentationContainer.style.flexDirection = 'column';
      presentationContainer.style.height = '100vh';
      presentationContainer.style.margin = '0';
      presentationContainer.style.padding = '0';
    }

    overlay.innerHTML = `
      <h2>Match the Branch!</h2>
      <p>Drag each power to the correct branch of Ohio’s government.</p>
      <div class="matchGame" style="margin-top:18px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px;">
        <div class="branch" data-branch="legislative"><h3>Legislative</h3><div class="dropzone"></div></div>
        <div class="branch" data-branch="executive"><h3>Executive</h3><div class="dropzone"></div></div>
        <div class="branch" data-branch="judicial"><h3>Judicial</h3><div class="dropzone"></div></div>
      </div>
      <div class="tasks" style="margin-top:20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
        <div class="task" draggable="true" data-branch="legislative">Makes laws</div>
        <div class="task" draggable="true" data-branch="executive">Carries out laws</div>
        <div class="task" draggable="true" data-branch="judicial">Interprets laws</div>
      </div>
      <button id="matchCheckBtn" style="margin-top:18px;">Check Answers</button>
      <p id="matchMsg" style="margin-top:12px;font-weight:600"></p>
    `;

    presentationContainer.appendChild(overlay);

    const tasks = overlay.querySelectorAll('.task');
    const dropzones = overlay.querySelectorAll('.dropzone');

    tasks.forEach(t => {
      t.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', t.dataset.branch);
        e.dataTransfer.setData('taskHTML', t.outerHTML);
        setTimeout(() => (t.style.visibility = 'hidden'), 0);
      });
      t.addEventListener('dragend', () => (t.style.visibility = 'visible'));
    });

    dropzones.forEach(zone => {
      zone.addEventListener('dragover', e => e.preventDefault());
      zone.addEventListener('drop', e => {
        e.preventDefault();
        const branch = e.dataTransfer.getData('text/plain');
        const taskHTML = e.dataTransfer.getData('taskHTML');
        zone.innerHTML = taskHTML;
        const droppedTask = zone.querySelector('.task');
        droppedTask.dataset.branch = branch;
        droppedTask.draggable = false;
      });
    });

    overlay.querySelector('#matchCheckBtn').addEventListener('click', () => {
      let correct = 0;
      const branches = overlay.querySelectorAll('.branch');
      branches.forEach(b => {
        const t = b.querySelector('.task');
        if (t && t.dataset.branch === b.dataset.branch) correct++;
      });
      const msg = overlay.querySelector('#matchMsg');
      if (correct === 3) {
        msg.textContent = '🎉 Correct! All matches are right.';
        msg.style.color = 'green';
        completeTopic(key);
      } else {
        msg.textContent = '❌ Some matches are incorrect. Try again!';
        msg.style.color = 'red';
      }
    });
  }

  /* ---------- Lawmaker Game ---------- */
  function launchLawmakerGame(key) {
    const overlay = createOverlayWrapper();

    // 🔹 FIX: remove white space from study area
    if (studyContent) {
      studyContent.style.display = 'none';
      studyContent.style.height = '0';
      studyContent.style.overflow = 'hidden';
      studyContent.style.margin = '0';
      studyContent.style.padding = '0';
    }
    if (progressWrapper) {
      progressWrapper.style.display = 'none';
      progressWrapper.style.height = '0';
      progressWrapper.style.overflow = 'hidden';
      progressWrapper.style.margin = '0';
      progressWrapper.style.padding = '0';
    }
    if (presentationContainer) {
      presentationContainer.style.display = 'flex';
      presentationContainer.style.flexDirection = 'column';
      presentationContainer.style.height = '100vh';
      presentationContainer.style.margin = '0';
      presentationContainer.style.padding = '0';
    }

    overlay.innerHTML = `
      <h2>Be a Lawmaker!</h2>
      <p>Pick choices to pass your own Ohio law.</p>
      <div class="lawGame" style="margin-top:18px;">
        <div class="step step-1">
          <p><strong>1.</strong> Choose your law idea:</p>
          <button data-law="environment">Protect Ohio’s Rivers</button>
          <button data-law="education">Increase School Funding</button>
          <button data-law="roads">Fix State Roads</button>
        </div>
        <div class="step step-2" style="display:none;">
          <p><strong>2.</strong> Pick supporters for your bill:</p>
          <button data-support="bipartisan">Bipartisan</button>
          <button data-support="majority">Majority Only</button>
        </div>
        <div class="step step-3" style="display:none;">
          <p><strong>3.</strong> Choose the Governor’s action:</p>
          <button data-gov="sign">Sign into Law</button>
          <button data-gov="veto">Veto</button>
        </div>
      </div>
      <p id="lawMsg" style="margin-top:14px;font-weight:600"></p>
    `;

    presentationContainer.appendChild(overlay);

    const msg = overlay.querySelector('#lawMsg');
    const steps = overlay.querySelectorAll('.step');
    let currentStep = 0;

    function showStep(i) { steps.forEach((s, idx) => s.style.display = idx === i ? '' : 'none'); }

    overlay.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const btn = e.target;
      if (currentStep === 0) {
        currentStep = 1; showStep(currentStep);
      } else if (currentStep === 1) {
        currentStep = 2; showStep(currentStep);
      } else if (currentStep === 2) {
        if (btn.dataset.gov === 'sign') {
          msg.textContent = '🎉 The Governor signed your law! Well done, Lawmaker!';
          msg.style.color = 'green';
          completeTopic(key);
        } else {
          msg.textContent = '🚫 The Governor vetoed it. Try again!';
          msg.style.color = 'red';
          currentStep = 0; showStep(currentStep);
        }
      }
    });
  }

  /* ---------- Completion Handler ---------- */
  function completeTopic(key) {
    // ✅ Remove any overlay from screen
    const overlay = document.querySelector('.overlayWrapper');
    if (overlay) overlay.remove();

    // ✅ Mark the topic as completed visually
    const topicCard = document.querySelector(`[data-key="${key}"]`);
    if (topicCard) {
      topicCard.classList.add('completed');
      topicCard.innerHTML = `
        <div class="topic-complete">
          <p>✅ Completed!</p>
        </div>
      `;
    }

    // ✅ Restore layout for next use
    if (studyContent) {
      studyContent.style.display = '';
      studyContent.style.height = '';
      studyContent.style.overflow = '';
      studyContent.style.margin = '';
      studyContent.style.padding = '';
    }
    if (progressWrapper) {
      progressWrapper.style.display = '';
      progressWrapper.style.height = '';
      progressWrapper.style.overflow = '';
      progressWrapper.style.margin = '';
      progressWrapper.style.padding = '';
    }
    if (presentationContainer) {
      presentationContainer.style.display = '';
      presentationContainer.style.height = '';
      presentationContainer.style.margin = '';
      presentationContainer.style.padding = '';
    }
  }
})();

